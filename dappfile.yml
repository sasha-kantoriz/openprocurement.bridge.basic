---
dimg: 'component'
from: 'fedora:27'
docker:
  ENV: 
    TZ: Europe/Kiev
  USER: 'databridge:databridge'
  WORKDIR: '/opt/psale'
  CMD: 
    - bin/databridge
    - etc/databridge.yml
mount: 
  - to: '/var/cache/dnf'
    from: build_dir

git:
  - add: /
    to: /opt/psale/databridge
    owner: databridge
    group: databridge
    stageDependencies:
      beforeSetup: 
        - '*'
ansible:
  beforeInstall:
    - raw: dnf install --nodocs gcc python2-virtualenv libyaml libffi -y
    - group:
        name: databridge
        state: present
    - user:
        name: databridge
        shell: /bin/bash
        home: /opt/psale
        groups: 
          - databridge
          - wheel
        password: databridge
  install:
    - pip:
        requirements: /opt/psale/databridge/requirements.txt
        virtualenv: /opt/psale/databridge
      become_user: databridge
  beforeSetup:
    - shell: bin/buildout
      args:
        chdir: /opt/psale/databridge
      become_user: databridge
---
dimg: 'rpm'
fromDimg: 'component'
mount: 
  - to: '/var/cache/dnf'
    from: build_dir
  - to: '/root/rpmbuild'
    fromPath: '/home/psale/bridge/rpm'
docker:
  ENV: 
    TZ: Europe/Kiev
  USER: 'root:root'
  WORKDIR: '/root'
  CMD: 
    - bash
ansible:
  beforeInstall:
    - raw: dnf install --nodocs rpm-build -y 
    - shell: 'rpmbuild --define "release {{ env "RELEASE" }}" -ba /opt/psale/databridge/rpm/databridge.spec'
      args:
        chdir: '/root'
